{"version":3,"file":"index.js","sources":["../../../../../../node_modules/@typhonjs-svelte/trie-search/dist-trl/query/index.js"],"sourcesContent":["import { writable } from '#svelte/store';\nimport { TrieSearch } from '#runtime/data/struct/search/trie';\nimport { DynArrayReducer } from '#runtime/svelte/store/reducer';\nimport { isObject, isIterable } from '#runtime/util/object';\n\n/**\n * Provides a reactive query interface to {@link TrieSearch} in addition to dynamic filtering / sorting of search\n * results.\n *\n * @template T\n */\nclass TrieSearchQuery extends DynArrayReducer {\n    /**\n     * Provides the backing data for DynArrayReducer populated from search queries against the associated TrieSearch\n     * instance.\n     */\n    #data = [];\n    /**\n     * The current limit value passed onto associated TrieSearch to limit search results.\n     */\n    #currentLimit = undefined;\n    /**\n     * Stores the last set search query.\n     */\n    #currentQuery = '';\n    /**\n     * Stores the current destroyed state.\n     */\n    #isDestroyed = false;\n    /**\n     * Provides the external reactive writable store controlling the search results limit.\n     */\n    #storeLimit;\n    /**\n     * Provides the external reactive writable store controlling search queries.\n     */\n    #storeQuery = writable(this.#currentQuery);\n    /**\n     * The TrieSearch specific reducer instance.\n     */\n    #trieReducer;\n    /**\n     * Holds a weak reference to the associated TrieSearch instance.\n     */\n    #trieSearch;\n    /**\n     * Holds all unsubscribe functions.\n     */\n    #unsubscribers = [];\n    /**\n     * @param {TrieSearch<T>}  trieSearch - The associated TrieSearch instance.\n     *\n     * @param {TrieSearchQueryOptions<T>} options - Optional query settings.\n     */\n    constructor(trieSearch, options) {\n        super();\n        if (!(trieSearch instanceof TrieSearch)) {\n            throw new TypeError(`TrieSearchQuery error: 'trieSearch' must be an instance of TrieSearch.`);\n        }\n        if (options !== void 0 && !isObject(options)) {\n            throw new TypeError(`TrieSearchQuery error: 'options' must be an object.`);\n        }\n        if (options?.trieReducer !== void 0 && typeof options.trieReducer?.reduce !== 'function') {\n            throw new TypeError(`TrieSearchQuery error: 'options.trieReducer' must implement ITrieSearchReducer.`);\n        }\n        if (options?.limit !== void 0 && (!Number.isInteger(options.limit) || options.limit < 0)) {\n            throw new TypeError(`TrieSearchQuery error: 'options.limit' must be an integer >= 0.`);\n        }\n        // Replace backing array of DynArrayReducer with local data array.\n        super.setData(this.#data, true);\n        this.#trieSearch = new WeakRef(trieSearch);\n        this.#trieReducer = options?.trieReducer;\n        this.#currentLimit = options?.limit;\n        this.#storeLimit = writable(this.#currentLimit);\n        // Have any changes to the associated TrieSearch instance trigger search updates or destroy.\n        this.#unsubscribers.push(trieSearch.subscribe(this.#updateTrieSearch.bind(this)));\n        // Have any changes to the limit store trigger search updates with the associated TrieSearch instance.\n        this.#unsubscribers.push(this.#storeLimit.subscribe(this.#updateLimit.bind(this)));\n        // Have any changes to the query store trigger search updates with the associated TrieSearch instance.\n        this.#unsubscribers.push(this.#storeQuery.subscribe(this.#updateQuery.bind(this)));\n    }\n    /**\n     * @returns {Writable<number | undefined>} The writable store controlling the search results limit.\n     */\n    get limit() { return this.#storeLimit; }\n    /**\n     * @returns {boolean} The current destroyed state of this query instance.\n     */\n    get isDestroyed() { return this.#isDestroyed; }\n    /**\n     * @returns {TrieSearchReducer<T>} Any associated TrieSearch reducer function.\n     */\n    get trieReducer() { return this.#trieReducer; }\n    /**\n     * @returns {TrieSearch<T>} The associated TrieSearch instance; can be undefined.\n     */\n    get trieSearch() { return this.#trieSearch !== void 0 ? this.#trieSearch.deref() : void 0; }\n    /**\n     * @returns {Writable<string | Iterable<string> | undefined>} The writable store controlling the search query.\n     */\n    get query() { return this.#storeQuery; }\n    /**\n     * @param {TrieSearchReducer<T> | undefined}  trieReducer - A new trie reducer function.\n     */\n    set trieReducer(trieReducer) {\n        if (trieReducer !== void 0 && typeof trieReducer?.reduce !== 'function') {\n            throw new TypeError(`TrieSearchQuery.set error: 'trieReducer' must implement ITrieSearchReducer.`);\n        }\n        this.#trieReducer = trieReducer;\n        this.#performSearch();\n    }\n    /**\n     * Destroys and disconnects this query from the local stores and any associated TrieSearch instance.\n     */\n    destroy() {\n        // Unsubscribe from TrieSearch instance and local stores.\n        for (const unsubscribe of this.#unsubscribers) {\n            unsubscribe();\n        }\n        this.#unsubscribers.length = 0;\n        this.#trieSearch = void 0;\n        this.#isDestroyed = true;\n        // Remove any stored data and update DynArrayReducer index.\n        this.#data.length = 0;\n        super.index.update();\n    }\n    /**\n     * Performs a search with the associated TrieSearch instance.\n     */\n    #performSearch() {\n        // Reset the data array without changing instance.\n        this.#data.length = 0;\n        // Retrieve TrieSearch reference. It may have been garbage collected.\n        const trieSearch = this.trieSearch;\n        /* c8 ignore next 8 */\n        if (trieSearch === void 0) {\n            console.warn(`TrieSearchQuery warning: 'trieSearch' has been garbage collected; destroying this query instance`);\n            this.destroy();\n            return;\n        }\n        // Perform the trie search storing results in `this.#data`.\n        trieSearch.search(this.#currentQuery, {\n            limit: this.#currentLimit,\n            list: this.#data,\n            reducer: this.#trieReducer\n        });\n        // Update the non-destructive DynArrayReducer index.\n        super.index.update(true);\n    }\n    /**\n     * Receives updates from `#storeLimit`.\n     *\n     * @param {number | undefined}  limit - New search limit.\n     */\n    #updateLimit(limit) {\n        const isNumber = typeof limit === 'number';\n        if (limit !== void 0 && !isNumber) {\n            console.warn(`TrieSearchQuery warning: 'limit' must be a number or undefined; setting to undefined.`);\n            this.#storeLimit.set(void 0);\n            return;\n        }\n        if (isNumber && (!Number.isInteger(limit) || limit < 0)) {\n            console.warn(`TrieSearchQuery warning: 'limit' must be an integer >= 0; setting to undefined.`);\n            this.#storeLimit.set(void 0);\n            return;\n        }\n        this.#currentLimit = limit;\n        this.#performSearch();\n    }\n    /**\n     * Receives updates from `#storeQuery`.\n     *\n     * @param {string | Iterable<string> | undefined}  query - New search query.\n     */\n    #updateQuery(query) {\n        if (query !== void 0 && typeof query !== 'string' && !isIterable(query)) {\n            console.warn(`TrieSearchQuery warning: 'query' is not a string or iterable list of strings; setting to undefined.`);\n            this.#storeQuery.set(void 0);\n            return;\n        }\n        this.#currentQuery = query;\n        this.#performSearch();\n    }\n    /**\n     * Handles change notifications from the associated TrieSearch instance.\n     *\n     * @param {object}   options - Optional parameters.\n     *\n     * @param {string}   options.action - The associated TrieSearch action.\n     */\n    #updateTrieSearch({ action }) {\n        if (action === 'destroy') {\n            this.destroy();\n        }\n        else {\n            this.#performSearch();\n        }\n    }\n}\n\nexport { TrieSearchQuery };\n//# sourceMappingURL=index.js.map\n"],"names":[],"mappings":"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","x_google_ignoreList":[0]}