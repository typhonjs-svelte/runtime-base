{"version":3,"file":"index.js","sources":["../../../src/util/async/ManagedPromise.js"],"sourcesContent":["/**\r\n * Provides management of a single Promise that can be shared and accessed across JS & Svelte components. This allows a\r\n * Promise to be created and managed as part of the TRL application lifecycle and accessed safely in various control\r\n * flow scenarios. When resolution of the current managed Promise starts further interaction is prevented.\r\n *\r\n * Note: to enable debugging / log statements set the static `logging` variable to true.\r\n */\r\nexport class ManagedPromise\r\n{\r\n   /** @type {boolean} */\r\n   static #logging = false;\r\n\r\n   /** @type {{ isProcessing?: boolean, promise?: Promise, reject: Function, resolve: Function }} */\r\n   #current;\r\n\r\n   /**\r\n    * @returns {boolean} Whether global logging is enabled.\r\n    */\r\n   static get logging()\r\n   {\r\n      return this.#logging;\r\n   }\r\n\r\n   /**\r\n    * @returns {boolean} Whether there is an active managed Promise.\r\n    */\r\n   get isActive()\r\n   {\r\n      return this.#current !== void 0;\r\n   }\r\n\r\n   /**\r\n    * @returns {boolean} Whether there is an active managed Promise and resolution is currently being processed.\r\n    */\r\n   get isProcessing()\r\n   {\r\n      return this.#current !== void 0 ? this.#current.isProcessing : false;\r\n   }\r\n\r\n   /**\r\n    * Sets global logging enabled state.\r\n    *\r\n    * @param {boolean}  logging - New logging enabled state.\r\n    */\r\n   static set logging(logging)\r\n   {\r\n      if (typeof logging !== 'boolean')\r\n      {\r\n         throw new TypeError(`[TRL] ManagedPromise.logging error: 'logging' is not a boolean.`);\r\n      }\r\n\r\n      this.#logging = logging;\r\n   }\r\n\r\n   // ----------------------------------------------------------------------------------------------------------------\r\n\r\n   /**\r\n    * Resolves any current Promise with undefined and creates a new current Promise.\r\n    *\r\n    * @template T\r\n    *\r\n    * @param {object} opts - Options.\r\n    *\r\n    * @param {boolean}  [opts.reuse=false] - When true if there is an existing live Promise it is returned immediately.\r\n    *\r\n    * @returns {Promise<T>} The new current managed Promise.\r\n    */\r\n   create({ reuse = false } = {})\r\n   {\r\n      if (typeof reuse !== 'boolean')\r\n      {\r\n         throw new TypeError(`[TRL] ManagedPromise.create error: 'reuse' is not a boolean.`);\r\n      }\r\n\r\n      if (reuse && this.#current !== void 0 && this.#current.promise instanceof Promise)\r\n      {\r\n         if (ManagedPromise.#logging)\r\n         {\r\n            console.warn(`[TRL] ManagedPromise.create info: Reusing / returning existing managed Promise.`);\r\n         }\r\n\r\n         return this.#current.promise;\r\n      }\r\n\r\n      if (this.#current !== void 0)\r\n      {\r\n         if (ManagedPromise.#logging)\r\n         {\r\n            console.warn(\r\n             `[TRL] ManagedPromise.create info: Creating a new Promise and resolving existing immediately.`);\r\n         }\r\n\r\n         this.#current.resolve(void 0);\r\n         this.#current = void 0;\r\n      }\r\n\r\n      const promise = new Promise((resolve, reject) =>\r\n      {\r\n         this.#current = {\r\n            isProcessing: false,\r\n            reject,\r\n            resolve\r\n         };\r\n      });\r\n\r\n      this.#current.promise = promise;\r\n\r\n      return promise;\r\n   }\r\n\r\n   /**\r\n    * Gets the current Promise if any.\r\n    *\r\n    * @returns {Promise<any>} Current Promise.\r\n    */\r\n   get()\r\n   {\r\n      return this.#current ? this.#current.promise : void 0;\r\n   }\r\n\r\n   /**\r\n    * Rejects the current Promise if applicable.\r\n    *\r\n    * @param {*}  [result] - Result to reject.\r\n    *\r\n    * @returns {boolean} Was the promise rejected.\r\n    */\r\n   reject(result = void 0)\r\n   {\r\n      // Early out as Promise resolution is currently processing.\r\n      if (this.#current !== void 0 && this.#current.isProcessing)\r\n      {\r\n         if (ManagedPromise.#logging)\r\n         {\r\n            console.warn(`[TRL] ManagedPromise.reject info: Currently processing promise.`);\r\n         }\r\n\r\n         return true;\r\n      }\r\n\r\n      if (this.#current !== void 0)\r\n      {\r\n         this.#current.isProcessing = true;\r\n\r\n         if (result instanceof Promise)\r\n         {\r\n            result.then((value) =>\r\n            {\r\n               this.#current.reject(value);\r\n               this.#current = void 0;\r\n            }).catch((err) =>\r\n            {\r\n               this.#current.reject(err);\r\n               this.#current = void 0;\r\n            });\r\n         }\r\n         else\r\n         {\r\n            this.#current.reject(result);\r\n            this.#current = void 0;\r\n         }\r\n\r\n         return true;\r\n      }\r\n      else\r\n      {\r\n         if (ManagedPromise.#logging)\r\n         {\r\n            console.warn(`[TRL] ManagedPromise.reject warning: No current managed Promise to reject.`);\r\n         }\r\n\r\n         return false;\r\n      }\r\n   }\r\n\r\n   /**\r\n    * Resolves the current Promise if applicable.\r\n    *\r\n    * @param {*}  [result] - Result to resolve.\r\n    *\r\n    * @returns {boolean} Was the promise resolved.\r\n    */\r\n   resolve(result = void 0)\r\n   {\r\n      // Early out as Promise resolution is currently processing.\r\n      if (this.#current !== void 0 && this.#current.isProcessing)\r\n      {\r\n         if (ManagedPromise.#logging)\r\n         {\r\n            console.warn(`[TRL] ManagedPromise.resolve info: Currently processing promise.`);\r\n         }\r\n\r\n         return true;\r\n      }\r\n\r\n      if (this.#current !== void 0)\r\n      {\r\n         if (result instanceof Promise)\r\n         {\r\n            this.#current.isProcessing = true;\r\n\r\n            result.then((value) =>\r\n            {\r\n               this.#current.resolve(value);\r\n               this.#current = void 0;\r\n            }).catch((err) =>\r\n            {\r\n               this.#current.reject(err);\r\n               this.#current = void 0;\r\n            });\r\n         }\r\n         else\r\n         {\r\n            this.#current.resolve(result);\r\n            this.#current = void 0;\r\n         }\r\n\r\n         return true;\r\n      }\r\n      else\r\n      {\r\n         if (ManagedPromise.#logging)\r\n         {\r\n            console.warn(`[TRL] ManagedPromise.resolve warning: No current managed Promise to resolve.`);\r\n         }\r\n\r\n         return false;\r\n      }\r\n   }\r\n}\r\n"],"names":[],"mappings":"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"}