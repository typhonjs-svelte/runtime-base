{"version":3,"file":"index.js","sources":["../../../src/util/async/ImageData.js","../../../src/util/async/ManagedPromise.js"],"sourcesContent":["import {\r\n   isIterable,\r\n   isObject,\r\n   safeAccess }   from '#runtime/util/object';\r\n\r\n/**\r\n * Provides utility functions for retrieving data about images.\r\n */\r\nexport class ImageData\r\n{\r\n   /**\r\n    * Loads given URLs into image elements returning those that resolved with width & height dimensions. This is useful\r\n    * when the size of an image is necessary before usage.\r\n    *\r\n    * @param {string | { url?: string } | Iterable<string | { url?: string }>} urls - A list of image URLS to load or\r\n    *        object with an `url` property.\r\n    *\r\n    * @param {object} [options] - Optional options.\r\n    *\r\n    * @param {string} [options.accessor='url'] - Accessor string to access child attribute when `urls` entry contains\r\n    *        objects.\r\n    *\r\n    * @param {boolean} [options.warn=false] - Log debug warnings when a target URL can not be determined; default: false.\r\n    *\r\n    * @returns {(Promise<{\r\n    *    fulfilled: { url: string, width: number, height: number }[],\r\n    *    rejected: { url: string }[]\r\n    * }>)} An object with `fulfilled` and `rejected` requests.\r\n    */\r\n   static async getDimensions(urls, { accessor = 'url', warn = false } = {})\r\n   {\r\n      const promises = [];\r\n      const fulfilled = [];\r\n      const rejected = [];\r\n\r\n      const targetURLs = isIterable(urls) ? urls : [urls];\r\n\r\n      for (const url of targetURLs)\r\n      {\r\n         let targetURL;\r\n\r\n         if (typeof url === 'string')\r\n         {\r\n            targetURL = url;\r\n         }\r\n         else if (isObject(url))\r\n         {\r\n            targetURL = safeAccess(url, accessor);\r\n         }\r\n\r\n         if (typeof targetURL !== 'string')\r\n         {\r\n            if (warn)\r\n            {\r\n               console.warn('ImageData.getDimensions warning: Failed to locate target URL.');\r\n            }\r\n\r\n            continue;\r\n         }\r\n\r\n         promises.push(new Promise((resolve, reject) =>\r\n         {\r\n            const img = new Image();\r\n            img.src = targetURL;\r\n\r\n            // Get the actual width / height of the image.\r\n            img.onload = () => resolve({ url: targetURL, width: img.naturalWidth, height: img.naturalHeight });\r\n            img.onerror = () => reject({ url: targetURL });\r\n         }));\r\n      }\r\n\r\n      const promiseResults = await Promise.allSettled(promises);\r\n\r\n      for (const result of promiseResults)\r\n      {\r\n         switch (result.status)\r\n         {\r\n            case 'fulfilled':\r\n               fulfilled.push(result.value);\r\n               break;\r\n\r\n            case 'rejected':\r\n               rejected.push(result.reason);\r\n               break;\r\n         }\r\n      }\r\n\r\n      return { fulfilled, rejected };\r\n   }\r\n}\r\n","import { CrossWindow } from '#runtime/util/browser';\r\n\r\n/**\r\n * Provides management of a single Promise that can be shared and accessed across JS & Svelte components. This allows a\r\n * Promise to be created and managed as part of the TRL application lifecycle and accessed safely in various control\r\n * flow scenarios. When resolution of the current managed Promise starts further interaction is prevented.\r\n *\r\n * Note: to enable debugging / log statements set the static `logging` variable to true.\r\n */\r\nexport class ManagedPromise\r\n{\r\n   /** @type {boolean} */\r\n   static #logging = false;\r\n\r\n   /** @type {{ isProcessing?: boolean, promise?: Promise, reject: Function, resolve: Function }} */\r\n   #current;\r\n\r\n   /**\r\n    * @returns {boolean} Whether global logging is enabled.\r\n    */\r\n   static get logging()\r\n   {\r\n      return this.#logging;\r\n   }\r\n\r\n   /**\r\n    * @returns {boolean} Whether there is an active managed Promise.\r\n    */\r\n   get isActive()\r\n   {\r\n      return this.#current !== void 0;\r\n   }\r\n\r\n   /**\r\n    * @returns {boolean} Whether there is an active managed Promise and resolution is currently being processed.\r\n    */\r\n   get isProcessing()\r\n   {\r\n      return this.#current !== void 0 ? this.#current.isProcessing : false;\r\n   }\r\n\r\n   /**\r\n    * Sets global logging enabled state.\r\n    *\r\n    * @param {boolean}  logging - New logging enabled state.\r\n    */\r\n   static set logging(logging)\r\n   {\r\n      if (typeof logging !== 'boolean')\r\n      {\r\n         throw new TypeError(`[TRL] ManagedPromise.logging error: 'logging' is not a boolean.`);\r\n      }\r\n\r\n      this.#logging = logging;\r\n   }\r\n\r\n   // ----------------------------------------------------------------------------------------------------------------\r\n\r\n   /**\r\n    * Resolves any current Promise with undefined and creates a new current Promise.\r\n    *\r\n    * @template T\r\n    *\r\n    * @param {object} opts - Options.\r\n    *\r\n    * @param {boolean}  [opts.reuse=false] - When true if there is an existing live Promise it is returned immediately.\r\n    *\r\n    * @returns {Promise<T>} The new current managed Promise.\r\n    */\r\n   create({ reuse = false } = {})\r\n   {\r\n      if (typeof reuse !== 'boolean')\r\n      {\r\n         throw new TypeError(`[TRL] ManagedPromise.create error: 'reuse' is not a boolean.`);\r\n      }\r\n\r\n      if (reuse && this.#current !== void 0 && CrossWindow.isPromise(this.#current.promise))\r\n      {\r\n         if (ManagedPromise.#logging)\r\n         {\r\n            console.warn(`[TRL] ManagedPromise.create info: Reusing / returning existing managed Promise.`);\r\n         }\r\n\r\n         return this.#current.promise;\r\n      }\r\n\r\n      if (this.#current !== void 0)\r\n      {\r\n         if (ManagedPromise.#logging)\r\n         {\r\n            console.warn(\r\n             `[TRL] ManagedPromise.create info: Creating a new Promise and resolving existing immediately.`);\r\n         }\r\n\r\n         this.#current.resolve(void 0);\r\n         this.#current = void 0;\r\n      }\r\n\r\n      const promise = new Promise((resolve, reject) =>\r\n      {\r\n         this.#current = {\r\n            isProcessing: false,\r\n            reject,\r\n            resolve\r\n         };\r\n      });\r\n\r\n      this.#current.promise = promise;\r\n\r\n      return promise;\r\n   }\r\n\r\n   /**\r\n    * Gets the current Promise if any.\r\n    *\r\n    * @returns {Promise<any>} Current Promise.\r\n    */\r\n   get()\r\n   {\r\n      return this.#current ? this.#current.promise : void 0;\r\n   }\r\n\r\n   /**\r\n    * Rejects the current Promise if applicable.\r\n    *\r\n    * @param {*}  [result] - Result to reject.\r\n    *\r\n    * @returns {boolean} Was the promise rejected.\r\n    */\r\n   reject(result = void 0)\r\n   {\r\n      // Early out as Promise resolution is currently processing.\r\n      if (this.#current !== void 0 && this.#current.isProcessing)\r\n      {\r\n         if (ManagedPromise.#logging)\r\n         {\r\n            console.warn(`[TRL] ManagedPromise.reject info: Currently processing promise.`);\r\n         }\r\n\r\n         return true;\r\n      }\r\n\r\n      if (this.#current !== void 0)\r\n      {\r\n         this.#current.isProcessing = true;\r\n\r\n         if (CrossWindow.isPromise(result))\r\n         {\r\n            result.then((value) =>\r\n            {\r\n               this.#current.reject(value);\r\n               this.#current = void 0;\r\n            }).catch((err) =>\r\n            {\r\n               this.#current.reject(err);\r\n               this.#current = void 0;\r\n            });\r\n         }\r\n         else\r\n         {\r\n            this.#current.reject(result);\r\n            this.#current = void 0;\r\n         }\r\n\r\n         return true;\r\n      }\r\n      else\r\n      {\r\n         if (ManagedPromise.#logging)\r\n         {\r\n            console.warn(`[TRL] ManagedPromise.reject warning: No current managed Promise to reject.`);\r\n         }\r\n\r\n         return false;\r\n      }\r\n   }\r\n\r\n   /**\r\n    * Resolves the current Promise if applicable.\r\n    *\r\n    * @param {*}  [result] - Result to resolve.\r\n    *\r\n    * @returns {boolean} Was the promise resolved.\r\n    */\r\n   resolve(result = void 0)\r\n   {\r\n      // Early out as Promise resolution is currently processing.\r\n      if (this.#current !== void 0 && this.#current.isProcessing)\r\n      {\r\n         if (ManagedPromise.#logging)\r\n         {\r\n            console.warn(`[TRL] ManagedPromise.resolve info: Currently processing promise.`);\r\n         }\r\n\r\n         return true;\r\n      }\r\n\r\n      if (this.#current !== void 0)\r\n      {\r\n         if (CrossWindow.isPromise(result))\r\n         {\r\n            this.#current.isProcessing = true;\r\n\r\n            result.then((value) =>\r\n            {\r\n               this.#current.resolve(value);\r\n               this.#current = void 0;\r\n            }).catch((err) =>\r\n            {\r\n               this.#current.reject(err);\r\n               this.#current = void 0;\r\n            });\r\n         }\r\n         else\r\n         {\r\n            this.#current.resolve(result);\r\n            this.#current = void 0;\r\n         }\r\n\r\n         return true;\r\n      }\r\n      else\r\n      {\r\n         if (ManagedPromise.#logging)\r\n         {\r\n            console.warn(`[TRL] ManagedPromise.resolve warning: No current managed Promise to resolve.`);\r\n         }\r\n\r\n         return false;\r\n      }\r\n   }\r\n}\r\n"],"names":[],"mappings":"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"}